version: "3.8"

# Stack de Deploy para Portainer - Sistema de Agendamento Clínica
# Domínio: clinica.123atendi.com.br
# Imagens: 123atendi/clinica-agendamento-backend e frontend

services:
  # Backend Node.js API
  backend:
    image: 123atendi/clinica-agendamento-backend:latest
    networks:
      - clinica-internal
      - externa
    environment:
      # Configurações de ambiente (editáveis no Portainer)
      - NODE_ENV=production
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-seu-secret-super-seguro-aqui-change-me}
      - CORS_ORIGIN=https://clinica.123atendi.com.br
    volumes:
      # Persistência do banco SQLite
      - clinica-db:/app/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        # Habilitar Traefik
        traefik.enable: "true"

        # Configuração da rede Docker para Traefik
        traefik.docker.network: "externa"

        # Configuração do roteador HTTP para API
        traefik.http.routers.clinica-api.rule: "Host(`clinica.123atendi.com.br`) && PathPrefix(`/api`)"
        traefik.http.routers.clinica-api.entrypoints: "websecure"
        traefik.http.routers.clinica-api.priority: "10"
        traefik.http.routers.clinica-api.tls.certresolver: "le"
        traefik.http.routers.clinica-api.service: "clinica-api"

        # Configuração do serviço
        traefik.http.services.clinica-api.loadbalancer.server.port: "3001"
        traefik.http.services.clinica-api.loadbalancer.passHostHeader: "true"

        # Middleware de CORS para API
        traefik.http.middlewares.clinica-cors.headers.accesscontrolallowmethods: "GET,POST,PUT,DELETE,OPTIONS,PATCH"
        traefik.http.middlewares.clinica-cors.headers.accesscontrolallowheaders: "Content-Type,Authorization,X-Requested-With"
        traefik.http.middlewares.clinica-cors.headers.accesscontrolalloworiginlist: "https://clinica.123atendi.com.br"
        traefik.http.middlewares.clinica-cors.headers.accesscontrolmaxage: "100"
        traefik.http.middlewares.clinica-cors.headers.addvaryheader: "true"

        # Aplicar middleware de CORS
        traefik.http.routers.clinica-api.middlewares: "clinica-cors"

  # Frontend React
  frontend:
    image: 123atendi/clinica-agendamento-frontend:latest
    networks:
      - clinica-internal
      - externa
    environment:
      # URL da API (editável no Portainer)
      - REACT_APP_API_URL=https://clinica.123atendi.com.br/api
    depends_on:
      - backend
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        # Habilitar Traefik
        traefik.enable: "true"

        # Configuração da rede Docker para Traefik
        traefik.docker.network: "externa"

        # Configuração do roteador HTTP para Frontend
        traefik.http.routers.clinica-frontend.rule: "Host(`clinica.123atendi.com.br`)"
        traefik.http.routers.clinica-frontend.entrypoints: "websecure"
        traefik.http.routers.clinica-frontend.priority: "1"
        traefik.http.routers.clinica-frontend.tls.certresolver: "le"
        traefik.http.routers.clinica-frontend.service: "clinica-frontend"

        # Configuração do serviço
        traefik.http.services.clinica-frontend.loadbalancer.server.port: "80"
        traefik.http.services.clinica-frontend.loadbalancer.passHostHeader: "true"

        # Middleware de compressão
        traefik.http.middlewares.clinica-compress.compress: "true"

        # Aplicar middleware de compressão
        traefik.http.routers.clinica-frontend.middlewares: "clinica-compress"

networks:
  # Rede interna para comunicação entre containers
  clinica-internal:
    driver: overlay
    internal: true

  # Rede externa para Traefik (já deve existir no Swarm)
  externa:
    external: true

volumes:
  # Volume para persistência do banco de dados SQLite
  clinica-db:
    driver: local
